<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯ç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³ - çµ±åˆãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        
        h2 {
            color: #555;
            margin-top: 20px;
        }
        
        .test-case {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #3498db;
            background-color: #f9f9f9;
        }
        
        .test-case.passed {
            border-left-color: #27ae60;
            background-color: #f0fdf4;
        }
        
        .test-case.failed {
            border-left-color: #e74c3c;
            background-color: #fef2f2;
        }
        
        .test-title {
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .test-result {
            font-size: 14px;
            color: #666;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status-badge.pass {
            background-color: #27ae60;
            color: white;
        }
        
        .status-badge.fail {
            background-color: #e74c3c;
            color: white;
        }
        
        .summary {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
        
        .summary-stat {
            display: inline-block;
            margin-right: 30px;
            font-size: 16px;
        }
        
        .summary-stat strong {
            color: #3498db;
        }
        
        .task-list {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .task-item {
            padding: 8px;
            margin: 5px 0;
            background-color: white;
            border-left: 3px solid #3498db;
            border-radius: 2px;
            font-size: 13px;
        }
        
        .task-item.daily {
            border-left-color: #3498db;
        }
        
        .task-item.weekly {
            border-left-color: #27ae60;
        }
        
        .task-item.monthly {
            border-left-color: #f39c12;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
    </style>
</head>
<body>
    <h1>ğŸ”„ ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯ç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³ - çµ±åˆãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-container">
        <h2>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h2>
        <button onclick="runAllTests()">ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ</button>
        <button onclick="clearResults()">çµæœã‚’ã‚¯ãƒªã‚¢</button>
    </div>
    
    <div id="results" class="test-container" style="display: none;">
        <h2>ãƒ†ã‚¹ãƒˆçµæœ</h2>
        <div id="test-results"></div>
        <div class="summary">
            <div class="summary-stat">åˆè¨ˆ: <strong id="total">0</strong></div>
            <div class="summary-stat">æˆåŠŸ: <strong id="passed" style="color: #27ae60;">0</strong></div>
            <div class="summary-stat">å¤±æ•—: <strong id="failed" style="color: #e74c3c;">0</strong></div>
            <div class="summary-stat">æˆåŠŸç‡: <strong id="rate">0%</strong></div>
        </div>
    </div>
    
    <script>
        // RecurrenceEngineã‚¯ãƒ©ã‚¹ã®å®Ÿè£…
        class RecurrenceEngine {
            constructor() {
                this.RECURRENCE_PATTERNS = {
                    'daily': { name: 'æ¯æ—¥', interval: 1 },
                    'weekly': { name: 'æ¯é€±', interval: 7 },
                    'monthly': { name: 'æ¯æœˆ', interval: 30 }
                };
            }
            
            generateTaskFromRecurrence(recurringTask, targetDate) {
                if (!recurringTask.is_recurring || !recurringTask.recurrence_pattern) {
                    return null;
                }
                
                if (recurringTask.recurrence_end_date) {
                    const endDate = new Date(recurringTask.recurrence_end_date);
                    endDate.setHours(0, 0, 0, 0);
                    targetDate.setHours(0, 0, 0, 0);
                    
                    if (targetDate > endDate) {
                        return null;
                    }
                }
                
                const newTask = {
                    id: `task-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    name: recurringTask.name,
                    estimated_time: recurringTask.estimated_time,
                    actual_time: 0,
                    priority: recurringTask.priority,
                    category: recurringTask.category,
                    assigned_date: formatDate(targetDate),
                    due_date: null,
                    details: recurringTask.details,
                    completed: false,
                    is_recurring: false,
                    recurrence_pattern: null,
                    recurrence_end_date: null
                };
                
                return newTask;
            }
            
            generateDailyTasks(recurringTask, startDate, endDate) {
                const generatedTasks = [];
                const currentDate = new Date(startDate);
                currentDate.setHours(0, 0, 0, 0);
                
                const end = new Date(endDate);
                end.setHours(0, 0, 0, 0);
                
                while (currentDate <= end) {
                    const newTask = this.generateTaskFromRecurrence(recurringTask, new Date(currentDate));
                    if (newTask) {
                        generatedTasks.push(newTask);
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                return generatedTasks;
            }
            
            generateWeeklyTasks(recurringTask, startDate, endDate) {
                const generatedTasks = [];
                const currentDate = new Date(startDate);
                currentDate.setHours(0, 0, 0, 0);
                
                const end = new Date(endDate);
                end.setHours(0, 0, 0, 0);
                
                while (currentDate <= end) {
                    const newTask = this.generateTaskFromRecurrence(recurringTask, new Date(currentDate));
                    if (newTask) {
                        generatedTasks.push(newTask);
                    }
                    currentDate.setDate(currentDate.getDate() + 7);
                }
                
                return generatedTasks;
            }
            
            generateMonthlyTasks(recurringTask, startDate, endDate) {
                const generatedTasks = [];
                const currentDate = new Date(startDate);
                currentDate.setHours(0, 0, 0, 0);
                
                const end = new Date(endDate);
                end.setHours(0, 0, 0, 0);
                
                const startDay = currentDate.getDate();
                
                while (currentDate <= end) {
                    const newTask = this.generateTaskFromRecurrence(recurringTask, new Date(currentDate));
                    if (newTask) {
                        generatedTasks.push(newTask);
                    }
                    
                    currentDate.setDate(1);
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    
                    const lastDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
                    if (startDay > lastDayOfMonth) {
                        currentDate.setDate(lastDayOfMonth);
                    } else {
                        currentDate.setDate(startDay);
                    }
                }
                
                return generatedTasks;
            }
            
            isRecurrenceActive(recurringTask) {
                if (!recurringTask.is_recurring) {
                    return false;
                }
                
                if (recurringTask.recurrence_end_date) {
                    const endDate = new Date(recurringTask.recurrence_end_date);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    return today <= endDate;
                }
                
                return true;
            }
            
            generateAllRecurringTasks(recurringTasks, startDate, endDate) {
                const allGeneratedTasks = [];
                
                recurringTasks.forEach(recurringTask => {
                    if (!this.isRecurrenceActive(recurringTask)) {
                        return;
                    }
                    
                    let generatedTasks = [];
                    
                    switch (recurringTask.recurrence_pattern) {
                        case 'daily':
                            generatedTasks = this.generateDailyTasks(recurringTask, startDate, endDate);
                            break;
                        case 'weekly':
                            generatedTasks = this.generateWeeklyTasks(recurringTask, startDate, endDate);
                            break;
                        case 'monthly':
                            generatedTasks = this.generateMonthlyTasks(recurringTask, startDate, endDate);
                            break;
                    }
                    
                    allGeneratedTasks.push(...generatedTasks);
                });
                
                return allGeneratedTasks;
            }
        }
        
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        let testResults = [];
        
        function addTestResult(testName, passed, details = '') {
            testResults.push({ testName, passed, details });
        }
        
        function runAllTests() {
            testResults = [];
            const engine = new RecurrenceEngine();
            
            // ãƒ†ã‚¹ãƒˆ1: æ¯æ—¥ãƒ‘ã‚¿ãƒ¼ãƒ³
            const dailyTask = {
                id: 'task-1',
                name: 'æ¯æ—¥ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼',
                estimated_time: 1,
                priority: 'medium',
                category: 'review',
                details: 'æ—¥æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼',
                is_recurring: true,
                recurrence_pattern: 'daily',
                recurrence_end_date: null
            };
            
            const dailyTasks = engine.generateDailyTasks(dailyTask, new Date('2024-01-01'), new Date('2024-01-07'));
            addTestResult('æ¯æ—¥ãƒ‘ã‚¿ãƒ¼ãƒ³ (7æ—¥é–“)', dailyTasks.length === 7, `ç”Ÿæˆ: ${dailyTasks.length}ã‚¿ã‚¹ã‚¯`);
            
            // ãƒ†ã‚¹ãƒˆ2: æ¯é€±ãƒ‘ã‚¿ãƒ¼ãƒ³
            const weeklyTask = {
                id: 'task-2',
                name: 'é€±æ¬¡ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°',
                estimated_time: 2,
                priority: 'high',
                category: 'meeting',
                details: 'é€±æ¬¡ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°',
                is_recurring: true,
                recurrence_pattern: 'weekly',
                recurrence_end_date: null
            };
            
            const weeklyTasks = engine.generateWeeklyTasks(weeklyTask, new Date('2024-01-01'), new Date('2024-01-29'));
            addTestResult('æ¯é€±ãƒ‘ã‚¿ãƒ¼ãƒ³ (4é€±é–“)', weeklyTasks.length === 5, `ç”Ÿæˆ: ${weeklyTasks.length}ã‚¿ã‚¹ã‚¯`);
            
            // ãƒ†ã‚¹ãƒˆ3: æ¯æœˆãƒ‘ã‚¿ãƒ¼ãƒ³
            const monthlyTask = {
                id: 'task-3',
                name: 'æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ',
                estimated_time: 4,
                priority: 'high',
                category: 'document',
                details: 'æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ',
                is_recurring: true,
                recurrence_pattern: 'monthly',
                recurrence_end_date: null
            };
            
            const monthlyTasks = engine.generateMonthlyTasks(monthlyTask, new Date('2024-01-15'), new Date('2024-03-15'));
            addTestResult('æ¯æœˆãƒ‘ã‚¿ãƒ¼ãƒ³ (3ãƒ¶æœˆ)', monthlyTasks.length === 3, `ç”Ÿæˆ: ${monthlyTasks.length}ã‚¿ã‚¹ã‚¯`);
            
            // ãƒ†ã‚¹ãƒˆ4: çµ‚äº†æ—¥ã®å‡¦ç†
            const limitedTask = {
                id: 'task-4',
                name: 'æœŸé–“é™å®šã‚¿ã‚¹ã‚¯',
                estimated_time: 1,
                priority: 'medium',
                category: 'task',
                details: 'æœŸé–“é™å®š',
                is_recurring: true,
                recurrence_pattern: 'daily',
                recurrence_end_date: '2024-01-05'
            };
            
            const limitedTasks = engine.generateDailyTasks(limitedTask, new Date('2024-01-01'), new Date('2024-01-10'));
            addTestResult('çµ‚äº†æ—¥ã®å‡¦ç†', limitedTasks.length === 5, `ç”Ÿæˆ: ${limitedTasks.length}ã‚¿ã‚¹ã‚¯ (çµ‚äº†æ—¥: 2024-01-05)`);
            
            // ãƒ†ã‚¹ãƒˆ5: è¤‡æ•°ã®ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯
            const allTasks = engine.generateAllRecurringTasks(
                [dailyTask, weeklyTask, monthlyTask],
                new Date('2024-01-01'),
                new Date('2024-01-31')
            );
            addTestResult('è¤‡æ•°ã®ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯', allTasks.length > 0, `ç”Ÿæˆ: ${allTasks.length}ã‚¿ã‚¹ã‚¯`);
            
            // ãƒ†ã‚¹ãƒˆ6: æœˆæœ«ã®æ—¥ä»˜èª¿æ•´
            const monthEndTask = {
                id: 'task-6',
                name: 'æœˆæœ«ã‚¿ã‚¹ã‚¯',
                estimated_time: 1,
                priority: 'medium',
                category: 'task',
                details: 'ãƒ†ã‚¹ãƒˆ',
                is_recurring: true,
                recurrence_pattern: 'monthly',
                recurrence_end_date: null
            };
            
            const monthEndTasks = engine.generateMonthlyTasks(monthEndTask, new Date('2024-01-31'), new Date('2024-03-31'));
            const isCorrect = monthEndTasks.length === 3 && 
                            monthEndTasks[0].assigned_date === '2024-01-31' &&
                            monthEndTasks[1].assigned_date === '2024-02-29' &&
                            monthEndTasks[2].assigned_date === '2024-03-31';
            addTestResult('æœˆæœ«ã®æ—¥ä»˜èª¿æ•´', isCorrect, `ç”Ÿæˆ: ${monthEndTasks.map(t => t.assigned_date).join(', ')}`);
            
            displayResults();
        }
        
        function displayResults() {
            const resultsDiv = document.getElementById('results');
            const testResultsDiv = document.getElementById('test-results');
            
            let html = '';
            let passed = 0;
            let failed = 0;
            
            testResults.forEach(result => {
                passed += result.passed ? 1 : 0;
                failed += result.passed ? 0 : 1;
                
                const className = result.passed ? 'passed' : 'failed';
                const badge = result.passed ? 
                    '<span class="status-badge pass">âœ… PASS</span>' : 
                    '<span class="status-badge fail">âŒ FAIL</span>';
                
                html += `
                    <div class="test-case ${className}">
                        <div class="test-title">${result.testName}${badge}</div>
                        <div class="test-result">${result.details}</div>
                    </div>
                `;
            });
            
            testResultsDiv.innerHTML = html;
            
            const total = testResults.length;
            const rate = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;
            
            document.getElementById('total').textContent = total;
            document.getElementById('passed').textContent = passed;
            document.getElementById('failed').textContent = failed;
            document.getElementById('rate').textContent = rate + '%';
            
            resultsDiv.style.display = 'block';
        }
        
        function clearResults() {
            testResults = [];
            document.getElementById('results').style.display = 'none';
        }
    </script>
</body>
</html>
