<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Validation Integration Tests</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .test-case {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border-left: 4px solid #ddd;
            border-radius: 4px;
        }
        .test-case.passed {
            border-left-color: #28a745;
            background-color: #f0f8f4;
        }
        .test-case.failed {
            border-left-color: #dc3545;
            background-color: #fdf8f8;
        }
        .test-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .test-result {
            font-size: 14px;
            color: #666;
        }
        .passed {
            color: #28a745;
        }
        .failed {
            color: #dc3545;
        }
        .summary {
            background-color: #e7f3ff;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .summary-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: #007bff;
        }
        .summary-item {
            margin: 5px 0;
            font-size: 14px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .controls {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>‚è±Ô∏è Time Validation Integration Tests</h1>
    
    <div class="controls">
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearTestData()">Clear Test Data</button>
        <button onclick="resetLocalStorage()">Reset LocalStorage</button>
    </div>

    <div id="test-results"></div>
    <div id="summary"></div>

    <script>
        // Test utilities
        const testResults = [];

        function addTestResult(testName, passed, message) {
            testResults.push({ testName, passed, message });
            displayTestResult(testName, passed, message);
        }

        function displayTestResult(testName, passed, message) {
            const resultsDiv = document.getElementById('test-results');
            const testCase = document.createElement('div');
            testCase.className = `test-case ${passed ? 'passed' : 'failed'}`;
            
            const testNameDiv = document.createElement('div');
            testNameDiv.className = 'test-name';
            testNameDiv.textContent = testName;
            
            const testResultDiv = document.createElement('div');
            testResultDiv.className = 'test-result';
            
            const statusSpan = document.createElement('span');
            statusSpan.className = passed ? 'passed' : 'failed';
            statusSpan.textContent = passed ? '‚úÖ PASSED' : '‚ùå FAILED';
            
            testResultDiv.appendChild(statusSpan);
            
            if (message) {
                const messageText = document.createTextNode(` - ${message}`);
                testResultDiv.appendChild(messageText);
            }
            
            testCase.appendChild(testNameDiv);
            testCase.appendChild(testResultDiv);
            resultsDiv.appendChild(testCase);
        }

        function displaySummary() {
            const passed = testResults.filter(r => r.passed).length;
            const failed = testResults.filter(r => !r.passed).length;
            const total = testResults.length;

            const summaryDiv = document.getElementById('summary');
            summaryDiv.textContent = '';
            
            const summaryContainer = document.createElement('div');
            summaryContainer.className = 'summary';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'summary-title';
            titleDiv.textContent = 'üìä Test Summary';
            summaryContainer.appendChild(titleDiv);
            
            const totalDiv = document.createElement('div');
            totalDiv.className = 'summary-item';
            const totalStrong = document.createElement('strong');
            totalStrong.textContent = total.toString();
            totalDiv.appendChild(document.createTextNode('Total Tests: '));
            totalDiv.appendChild(totalStrong);
            summaryContainer.appendChild(totalDiv);
            
            const passedDiv = document.createElement('div');
            passedDiv.className = 'summary-item';
            const passedSpan = document.createElement('span');
            passedSpan.className = 'passed';
            passedSpan.textContent = `‚úÖ Passed: ${passed}`;
            passedDiv.appendChild(passedSpan);
            summaryContainer.appendChild(passedDiv);
            
            const failedDiv = document.createElement('div');
            failedDiv.className = 'summary-item';
            const failedSpan = document.createElement('span');
            failedSpan.className = 'failed';
            failedSpan.textContent = `‚ùå Failed: ${failed}`;
            failedDiv.appendChild(failedSpan);
            summaryContainer.appendChild(failedDiv);
            
            const rateDiv = document.createElement('div');
            rateDiv.className = 'summary-item';
            const rateStrong = document.createElement('strong');
            rateStrong.textContent = `${total > 0 ? ((passed/total)*100).toFixed(1) : 0}%`;
            rateDiv.appendChild(document.createTextNode('Success Rate: '));
            rateDiv.appendChild(rateStrong);
            summaryContainer.appendChild(rateDiv);
            
            summaryDiv.appendChild(summaryContainer);
        }

        // Validation functions
        function validateTaskTimeData(task) {
            const errors = [];
            const warnings = [];
            
            if (task.estimated_time === undefined || task.estimated_time === null) {
                errors.push('estimated_time is missing');
                task.estimated_time = 0;
            } else if (typeof task.estimated_time !== 'number') {
                errors.push(`estimated_time must be a number`);
                task.estimated_time = 0;
            } else if (task.estimated_time < 0) {
                errors.push('estimated_time cannot be negative');
                task.estimated_time = 0;
            }
            
            if (task.actual_time === undefined || task.actual_time === null) {
                errors.push('actual_time is missing');
                task.actual_time = 0;
            } else if (typeof task.actual_time !== 'number') {
                errors.push(`actual_time must be a number`);
                task.actual_time = 0;
            } else if (task.actual_time < 0) {
                errors.push('actual_time cannot be negative');
                task.actual_time = 0;
            }
            
            if (task.actual_time > task.estimated_time * 1.5) {
                warnings.push(`actual_time exceeds estimated_time`);
            }
            
            task.estimated_time = Math.round(task.estimated_time * 100) / 100;
            task.actual_time = Math.round(task.actual_time * 100) / 100;
            
            return {
                isValid: errors.length === 0,
                errors,
                warnings,
                task
            };
        }

        // Test Suite 1: Valid Time Data Persistence
        function testValidTimeDataPersistence() {
            console.log('Running: Valid Time Data Persistence');
            
            localStorage.clear();
            
            const tasks = [
                { id: 'task-1', name: 'Task 1', estimated_time: 5, actual_time: 3 },
                { id: 'task-2', name: 'Task 2', estimated_time: 8, actual_time: 7 }
            ];
            
            localStorage.setItem('weekly-task-board.tasks', JSON.stringify(tasks));
            
            const retrieved = JSON.parse(localStorage.getItem('weekly-task-board.tasks'));
            const passed = retrieved[0].estimated_time === 5 && retrieved[0].actual_time === 3;
            
            addTestResult(
                'Valid Time Data Persistence',
                passed,
                passed ? 'Time data persisted correctly' : 'Failed to persist time data'
            );
        }

        // Test Suite 2: Invalid Time Data Correction
        function testInvalidTimeDataCorrection() {
            console.log('Running: Invalid Time Data Correction');
            
            localStorage.clear();
            
            const task = {
                id: 'task-1',
                name: 'Task 1',
                estimated_time: -5,
                actual_time: 'invalid'
            };
            
            const result = validateTaskTimeData(task);
            
            const passed = task.estimated_time === 0 && task.actual_time === 0 && !result.isValid;
            
            addTestResult(
                'Invalid Time Data Correction',
                passed,
                passed ? 'Invalid data corrected' : 'Failed to correct invalid data'
            );
        }

        // Test Suite 3: Time Warning Detection
        function testTimeWarningDetection() {
            console.log('Running: Time Warning Detection');
            
            localStorage.clear();
            
            const task = {
                id: 'task-1',
                name: 'Task 1',
                estimated_time: 5,
                actual_time: 10
            };
            
            const result = validateTaskTimeData(task);
            
            const passed = result.isValid && result.warnings.length > 0;
            
            addTestResult(
                'Time Warning Detection',
                passed,
                passed ? 'Warning detected correctly' : 'Failed to detect warning'
            );
        }

        // Test Suite 4: Batch Time Validation
        function testBatchTimeValidation() {
            console.log('Running: Batch Time Validation');
            
            localStorage.clear();
            
            const tasks = [
                { id: 'task-1', name: 'Task 1', estimated_time: 5, actual_time: 3 },
                { id: 'task-2', name: 'Task 2', estimated_time: -3, actual_time: 4 },
                { id: 'task-3', name: 'Task 3', estimated_time: 8, actual_time: 8 }
            ];
            
            let validCount = 0;
            tasks.forEach(task => {
                const result = validateTaskTimeData(task);
                if (result.isValid) validCount++;
            });
            
            const passed = validCount === 2;
            
            addTestResult(
                'Batch Time Validation',
                passed,
                passed ? '2 out of 3 tasks validated' : 'Batch validation failed'
            );
        }

        // Test Suite 5: Decimal Precision
        function testDecimalPrecision() {
            console.log('Running: Decimal Precision');
            
            localStorage.clear();
            
            const task = {
                id: 'task-1',
                name: 'Task 1',
                estimated_time: 5.12345,
                actual_time: 3.98765
            };
            
            const result = validateTaskTimeData(task);
            
            const passed = task.estimated_time === 5.12 && task.actual_time === 3.99;
            
            addTestResult(
                'Decimal Precision',
                passed,
                passed ? 'Decimals rounded correctly' : 'Decimal rounding failed'
            );
        }

        // Test Suite 6: Zero Time Values
        function testZeroTimeValues() {
            console.log('Running: Zero Time Values');
            
            localStorage.clear();
            
            const task = {
                id: 'task-1',
                name: 'Task 1',
                estimated_time: 0,
                actual_time: 0
            };
            
            const result = validateTaskTimeData(task);
            
            const passed = result.isValid && task.estimated_time === 0 && task.actual_time === 0;
            
            addTestResult(
                'Zero Time Values',
                passed,
                passed ? 'Zero values handled correctly' : 'Zero value handling failed'
            );
        }

        // Test Suite 7: Missing Time Fields
        function testMissingTimeFields() {
            console.log('Running: Missing Time Fields');
            
            localStorage.clear();
            
            const task = {
                id: 'task-1',
                name: 'Task 1'
            };
            
            const result = validateTaskTimeData(task);
            
            const passed = !result.isValid && task.estimated_time === 0 && task.actual_time === 0;
            
            addTestResult(
                'Missing Time Fields',
                passed,
                passed ? 'Missing fields handled correctly' : 'Missing field handling failed'
            );
        }

        // Test Suite 8: Time Data Type Validation
        function testTimeDataTypeValidation() {
            console.log('Running: Time Data Type Validation');
            
            localStorage.clear();
            
            const task = {
                id: 'task-1',
                name: 'Task 1',
                estimated_time: '5',
                actual_time: true
            };
            
            const result = validateTaskTimeData(task);
            
            const passed = !result.isValid && task.estimated_time === 0 && task.actual_time === 0;
            
            addTestResult(
                'Time Data Type Validation',
                passed,
                passed ? 'Type validation works correctly' : 'Type validation failed'
            );
        }

        // Main test runner
        function runAllTests() {
            testResults.length = 0;
            const testResultsDiv = document.getElementById('test-results');
            while (testResultsDiv.firstChild) {
                testResultsDiv.removeChild(testResultsDiv.firstChild);
            }
            const summaryDiv = document.getElementById('summary');
            while (summaryDiv.firstChild) {
                summaryDiv.removeChild(summaryDiv.firstChild);
            }
            
            console.log('Starting Time Validation Integration Tests...');
            
            testValidTimeDataPersistence();
            testInvalidTimeDataCorrection();
            testTimeWarningDetection();
            testBatchTimeValidation();
            testDecimalPrecision();
            testZeroTimeValues();
            testMissingTimeFields();
            testTimeDataTypeValidation();
            
            displaySummary();
            console.log('Tests completed!');
        }

        // Utility functions
        function clearTestData() {
            localStorage.clear();
            alert('Test data cleared!');
        }

        function resetLocalStorage() {
            localStorage.clear();
            alert('LocalStorage reset!');
        }

        // Auto-run tests on page load
        window.addEventListener('load', () => {
            console.log('Page loaded, ready to run tests');
        });
    </script>
</body>
</html>
